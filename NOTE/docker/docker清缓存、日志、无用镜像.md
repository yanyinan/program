# dockeræ¸…ç¼“å­˜ã€æ—¥å¿—ã€æ— ç”¨é•œåƒ

```shell
docker system df
```

 æŸ¥çœ‹dockerå„ç±»å‹æ–‡ä»¶å ç”¨æƒ…å†µ

```shell
docker system df
```

è¯¥å‘½ä»¤åˆ—å‡ºäº† docker ä½¿ç”¨ç£ç›˜çš„ 4 ç§ç±»å‹ï¼š

> Images: æ‰€æœ‰é•œåƒå ç”¨çš„ç©ºé—´ï¼ŒåŒ…æ‹¬æ‹‰å–çš„é•œåƒã€æœ¬åœ°æ„å»ºçš„é•œåƒ
>
> Containers: è¿è¡Œä¸­çš„å®¹å™¨æ‰€å ç”¨çš„ç©ºé—´ï¼ˆæ²¡è¿è¡Œå°±ä¸å ç©ºé—´ï¼‰ï¼Œå…¶å®å°±æ˜¯æ¯ä¸ªå®¹å™¨è¯»å†™å±‚çš„ç©ºé—´
>
> Local Volumes: æœ¬åœ°æ•°æ®å·çš„ç©ºé—´
>
> Build Cache: é•œåƒæ„å»ºè¿‡ç¨‹ä¸­ï¼Œäº§ç”Ÿçš„ç¼“å­˜æ•°æ®

`RECLAIMABL` è¿™ä¸ªå­—æ®µæ˜ç¡®äº†è¯¥ç±»å‹ä¸­å¯ä»¥æ¸…ç†çš„ç©ºé—´

## æŸ¥çœ‹æ¯ä¸ªimageã€containerå ç”¨æƒ…å†µ

```shell
docker system df -v
```

æˆ‘ä»¬ä½¿ç”¨ docker é•œåƒåˆ›å»ºå®¹å™¨æ—¶ï¼Œdockerä¼šåˆ›å»ºä¸€äº›ç›®å½•ï¼Œå¦‚ï¼š

> `/var/lib/docker/containers/<å®¹å™¨ID> `ç›®å½•ï¼Œå¦‚æœå®¹å™¨ä½¿ç”¨äº†é»˜è®¤çš„æ—¥å¿—æ¨¡å¼ï¼Œé‚£ä¹ˆè¯¥å®¹å™¨çš„æ—¥å¿—ä¼šä»¥ `JSON `å½¢å¼ä¿å­˜åœ¨æ­¤ç›®å½•ä¸‹ã€‚
> `/var/lib/docker/overlay2` ç›®å½•ï¼Œè¯¥ç›®å½•åŒ…å«å®¹å™¨çš„è¯»å†™å±‚ï¼Œå¦‚æœå®¹å™¨ä½¿ç”¨è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿä¿å­˜äº†æ•°æ®ï¼Œé‚£ä¹ˆè¿™äº›æ•°æ®å°±ä¼šå†™åˆ°æ­¤ç›®å½•ä¸‹ã€‚

### 1ã€æ¸…ç†å®¹å™¨æ—¥å¿—

Containers åŒ…å«çš„æˆ‘ä»¬å®¹å™¨è‡ªèº«çš„å®¹é‡ã€äº§ç”Ÿçš„æ•°æ®å®¹é‡ã€äº§ç”Ÿçš„æ—¥å¿—å®¹é‡

\# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨ä¸‹æ—¥å¿—çš„å¤§å°

```shell
find /var/lib/docker/containers/ -name *-json.log |xargs du -sh
```

\# å†™ä¸ªç©ºæ–‡ä»¶åˆ°å®¹å™¨æ—¥å¿—ä¸­

```shell
cat /dev/null > /var/lib/docker/containers/3c1452f817fad2296d1c105112faed89d01feaa4ee094e8622c959e072012f7a/3c1452f817fad2296d1c105112faed89d01feaa4ee094e8622c959e072012f7a-json.log
```

\# å°†æŸä¸ªæ—¥å¿—æ–‡ä»¶æ¸…é›¶

```shell
truncate -s 0 /var/lib/docker/containers/3c1452f817fad2296d1c105112faed89d01feaa4ee094e8622c959e072012f7a/3c1452f817fad2296d1c105112faed89d01feaa4ee094e8622c959e072012f7a-json.log
```

è¿™é‡Œå¯ä»¥çœ‹å‡ºæˆ‘çš„å…¶ä¸­ä¸€ä¸ªå®¹å™¨çš„æ—¥å¿—å·²ç»åˆ°14G

è®¾ç½®å®¹å™¨æ—¥å¿—çš„æœ€å¤§å®¹é‡ï¼Œä¸‹é¢æ˜¯nginxçš„è®¾ç½®çš„ä¾‹å­

```shell
nginx:
image: nginx:1.12.1
restart: always
logging:
driver: "json-file"
options:
max-size: "5g"
```



### 2ã€æ¸…ç†æ— ç”¨çš„imageã€volumeã€container

å¦‚æœå‘ç°æœ‰äº›å®¹å™¨ã€æ•°æ®å·æ˜¯æ²¡æœ‰è¢«ä½¿ç”¨çš„ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤æ¸…ç† Docker å ç”¨çš„ç©ºé—´

 æ¸…ç†æ‰€æœ‰æ²¡ç”¨çš„imageã€volumeã€containerã€ ä½†æ˜¯è¿™ä¸ªå‘¢ä¼šæŠŠä½ æš‚æ—¶åœæ­¢çš„å®¹å™¨ã€é•œåƒä¹Ÿåˆ é™¤æ‰ã€å½“å‰å‘½ä»¤å¯ä»¥ç”¨äºæ¸…ç†ç£ç›˜ï¼Œåˆ é™¤å…³é—­çš„å®¹å™¨ã€æ— ç”¨çš„æ•°æ®å·å’Œç½‘ç»œï¼Œä»¥åŠdanglingé•œåƒï¼ˆå³æ— tagçš„é•œåƒï¼‰

```shell
docker system prune
```

\# å½“å‰å‘½ä»¤æ¸…ç†å¾—æ›´åŠ å½»åº•ï¼Œå¯ä»¥å°†æ²¡æœ‰å®¹å™¨ä½¿ç”¨Dockeré•œåƒéƒ½åˆ æ‰

```shell
docker system prune -a
```

å½“ç„¶ä¹Ÿæ˜¯æœ‰å…¶ä»–é€‰æ‹©çš„ï¼š

\#åˆ é™¤æ‰€æœ‰å…³é—­çš„å®¹å™¨ï¼š

```shell
docker ps -a | grep Exit | cut -d ' ' -f 1 | xargs docker rm
```

\#åˆ é™¤æ‰€æœ‰danglingé•œåƒï¼ˆå³æ— tagçš„é•œåƒï¼‰ï¼š

```shell
docker rmi $(docker images | grep "^<none>" | awk "{print $3}")
```

\#åˆ é™¤æ‰€æœ‰danglingæ•°æ®å·ï¼ˆå³æ— ç”¨çš„Volumeï¼‰ï¼š

```shell
docker volume rm $(docker volume ls -qf dangling=true)
```



\#æ•°æ®å·å®¹å™¨åˆ é™¤

```shell
docker rm -v å·å
```

å‚è€ƒå‘½ä»¤ï¼š

```shell
df -hæŸ¥çœ‹ç£ç›˜ä½¿ç”¨æƒ…å†µ
df -i æŸ¥çœ‹inodeä½¿ç”¨æƒ…å†µ
du -sh *æŸ¥çœ‹å½“å‰ç›®å½•ä¸‹å„ä¸ªæ–‡ä»¶åŠç›®å½•å ç”¨ç©ºé—´å¤§å°
df -hå’Œdu -shæ˜¾ç¤ºçš„ç£ç›˜å¤§å°ä¸ä¸€è‡´åŸå› åŠè§£å†³åŠæ³•
df -hTæ˜¾ç¤º132Gç©ºé—´å…¨éƒ¨å ç”¨ï¼Œdu -shæ˜¾ç¤ºåªå ç”¨**30G**docker system df
```

\# æŸ¥çœ‹dockerå„ç±»å‹æ–‡ä»¶å ç”¨æƒ…å†µ

```shell
docker system df
```

è¯¥å‘½ä»¤åˆ—å‡ºäº† docker ä½¿ç”¨ç£ç›˜çš„ 4 ç§ç±»å‹ï¼š

```shell
Images: æ‰€æœ‰é•œåƒå ç”¨çš„ç©ºé—´ï¼ŒåŒ…æ‹¬æ‹‰å–çš„é•œåƒã€æœ¬åœ°æ„å»ºçš„é•œåƒ

Containers: è¿è¡Œä¸­çš„å®¹å™¨æ‰€å ç”¨çš„ç©ºé—´ï¼ˆæ²¡è¿è¡Œå°±ä¸å ç©ºé—´ï¼‰ï¼Œå…¶å®å°±æ˜¯æ¯ä¸ªå®¹å™¨è¯»å†™å±‚çš„ç©ºé—´

Local Volumes: æœ¬åœ°æ•°æ®å·çš„ç©ºé—´

Build Cache: é•œåƒæ„å»ºè¿‡ç¨‹ä¸­ï¼Œäº§ç”Ÿçš„ç¼“å­˜æ•°æ®

\# RECLAIMABL è¿™ä¸ªå­—æ®µæ˜ç¡®äº†è¯¥ç±»å‹ä¸­å¯ä»¥æ¸…ç†çš„ç©ºé—´
```

 

## æŸ¥çœ‹æ¯ä¸ªimageã€containerå ç”¨æƒ…å†µ

```bash
docker system df -v
```

æˆ‘ä»¬ä½¿ç”¨ docker é•œåƒåˆ›å»ºå®¹å™¨æ—¶ï¼Œdockerä¼šåˆ›å»ºä¸€äº›ç›®å½•ï¼Œå¦‚ï¼š

/var/lib/docker/containers/<å®¹å™¨ID> ç›®å½•ï¼Œå¦‚æœå®¹å™¨ä½¿ç”¨äº†é»˜è®¤çš„æ—¥å¿—æ¨¡å¼ï¼Œé‚£ä¹ˆè¯¥å®¹å™¨çš„æ—¥å¿—ä¼šä»¥ JSON å½¢å¼ä¿å­˜åœ¨æ­¤ç›®å½•ä¸‹ã€‚
/var/lib/docker/overlay2 ç›®å½•ï¼Œè¯¥ç›®å½•åŒ…å«å®¹å™¨çš„è¯»å†™å±‚ï¼Œå¦‚æœå®¹å™¨ä½¿ç”¨è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿä¿å­˜äº†æ•°æ®ï¼Œé‚£ä¹ˆè¿™äº›æ•°æ®å°±ä¼šå†™åˆ°æ­¤ç›®å½•ä¸‹ã€‚

### 1ã€æ¸…ç†å®¹å™¨æ—¥å¿—

Containers åŒ…å«çš„æˆ‘ä»¬å®¹å™¨è‡ªèº«çš„å®¹é‡ã€äº§ç”Ÿçš„æ•°æ®å®¹é‡ã€äº§ç”Ÿçš„æ—¥å¿—å®¹é‡

\# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨ä¸‹æ—¥å¿—çš„å¤§å°

```bash
find /var/lib/docker/containers/ -name *-json.log |xargs du -sh
```

\# å†™ä¸ªç©ºæ–‡ä»¶åˆ°å®¹å™¨æ—¥å¿—ä¸­

```bash
cat /dev/null > /var/lib/docker/containers/3c1452f817fad2296d1c105112faed89d01feaa4ee094e8622c959e072012f7a/3c1452f817fad2296d1c105112faed89d01feaa4ee094e8622c959e072012f7a-json.log
```

\# å°†æŸä¸ªæ—¥å¿—æ–‡ä»¶æ¸…é›¶ğŸ†‘

```bash
truncate -s 0 /var/lib/docker/containers/3c1452f817fad2296d1c105112faed89d01feaa4ee094e8622c959e072012f7a/3c1452f817fad2296d1c105112faed89d01feaa4ee094e8622c959e072012f7a-json.logè¿™é‡Œå¯ä»¥çœ‹å‡ºæˆ‘çš„å…¶ä¸­ä¸€ä¸ªå®¹å™¨çš„æ—¥å¿—å·²ç»åˆ°`14G`
```

è®¾ç½®å®¹å™¨æ—¥å¿—çš„æœ€å¤§å®¹é‡ï¼Œä¸‹é¢æ˜¯`nginx`çš„è®¾ç½®çš„ä¾‹å­

```bash
nginx:
image: nginx:1.12.1
restart: always
logging:
driver: "json-file"
options:
max-size: "5g"
```

### 2ã€æ¸…ç†æ— ç”¨çš„imageã€volumeã€container

å¦‚æœå‘ç°æœ‰äº›å®¹å™¨ã€æ•°æ®å·æ˜¯æ²¡æœ‰è¢«ä½¿ç”¨çš„ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤æ¸…ç† Docker å ç”¨çš„ç©ºé—´

 	æ¸…ç†æ‰€æœ‰æ²¡ç”¨çš„imageã€volumeã€containerã€ä½†æ˜¯è¿™ä¸ªå‘¢ä¼šæŠŠä½ æš‚æ—¶åœæ­¢çš„å®¹å™¨ã€é•œåƒä¹Ÿåˆ é™¤æ‰ã€å½“å‰å‘½ä»¤å¯ä»¥ç”¨äºæ¸…ç†ç£ç›˜ï¼Œåˆ é™¤å…³é—­çš„å®¹å™¨ã€æ— ç”¨çš„æ•°æ®å·å’Œç½‘ç»œï¼Œä»¥åŠdanglingé•œåƒï¼ˆå³æ— tagçš„é•œåƒï¼‰

```bash
docker system prune
```

\# å½“å‰å‘½ä»¤æ¸…ç†å¾—æ›´åŠ å½»åº•ï¼Œå¯ä»¥å°†æ²¡æœ‰å®¹å™¨ä½¿ç”¨Dockeré•œåƒéƒ½åˆ æ‰

```bash
docker system prune -a
```

å½“ç„¶ä¹Ÿæ˜¯æœ‰å…¶ä»–é€‰æ‹©çš„ï¼š

\#åˆ é™¤æ‰€æœ‰å…³é—­çš„å®¹å™¨ï¼š

```bash
docker ps -a | grep Exit | cut -d ' ' -f 1 | xargs docker rm
```

\#åˆ é™¤æ‰€æœ‰danglingé•œåƒï¼ˆå³æ— tagçš„é•œåƒï¼‰ï¼š

```bash
docker rmi $(docker images | grep "^<none>" | awk "{print $3}")
```

\#åˆ é™¤æ‰€æœ‰danglingæ•°æ®å·ï¼ˆå³æ— ç”¨çš„Volumeï¼‰ï¼š

```bash
docker volume rm $(docker volume ls -qf dangling=true)
```

 

\#æ•°æ®å·å®¹å™¨åˆ é™¤

```bash
docker rm -v å·å
```

å‚è€ƒå‘½ä»¤ï¼š

```bash
df -hæŸ¥çœ‹ç£ç›˜ä½¿ç”¨æƒ…å†µ
df -i æŸ¥çœ‹inodeä½¿ç”¨æƒ…å†µ
du -sh *æŸ¥çœ‹å½“å‰ç›®å½•ä¸‹å„ä¸ªæ–‡ä»¶åŠç›®å½•å ç”¨ç©ºé—´å¤§å°
df -hå’Œdu -shæ˜¾ç¤ºçš„ç£ç›˜å¤§å°ä¸ä¸€è‡´åŸå› åŠè§£å†³åŠæ³•
df -hTæ˜¾ç¤º132Gç©ºé—´å…¨éƒ¨å ç”¨ï¼Œdu -shæ˜¾ç¤ºåªå ç”¨30G
```

